<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>
  <link rel="stylesheet" href="styles.css?v1.4">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }

    section {
        display: flex;
        justify-content: flex-start;
        position: relative;
        align-items: center;
        padding: 1% 2%;
        background-color: #f9f9f9;
        height: 60px;
        width: 100%;
    }

    .title {
        font-size: 24px;
        font-weight: bold;
        color: #772c33;
        margin: 0;
    }

    .container {
        width: 80vw;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: 80vh;
    }

    .title {
        font-size: 28px;
        font-weight: bold;
        color: #772c33;
        text-align: center;
        margin-bottom: 10px;
    }

    .chat-area {
        display: flex;
        flex-direction: column; 
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 6px;
        background-color: #fff;
    }

    .message {
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      max-width: 70%;
    }

    .user-message {
        background-color: #d98890;
        align-self: flex-end;
        text-align: right;
        border-top-left-radius: 15px;                                                                       
        border-top-right-radius: 15px;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 5px;
    }

    .ai-message {
        background-color: #f8dbde;
        align-self: flex-start;
        text-align: left;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 15px;
    }

    .input-area {
        display: flex;
        margin-top: 15px;
    }

    .input-area input {
        flex-grow: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .input-area button {
      padding: 10px 20px;
      margin-left: 10px;
      background-color: #772c33;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .input-area button:hover {
        background-color: #772c33;
        transform: scale(1.1);
    }
  </style>
</head>
<body>
    <section>
        <button id="menuB" onclick="window.location.href='main.html'" class="menu-button">
            Home
        </button>
    </section>
    <div class="title">Chat</div>
    <div id="intimacyDisplay" style="text-align:center; font-weight:bold; margin:10px;">
      Intimacy Level: 1
    </div>
    <div class="container">
        <div class="chat-area" id="chatArea"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type your message..." />
            <button id="sendButton">Send</button>
        </div>
    </div>

  <script type="module">
    import { auth, db, doc, onAuthStateChanged, updateDoc, arrayUnion, setDoc, getDoc } from "./firebaseInitializing.js?v1.0.3";

    const apiKey = "AIzaSyAaELFaZFNagkYJxrcMeq6UBBbH4odYTmc";
    let uid = null;

    let userMessageCount = parseInt(localStorage.getItem('userMessageCount')) || 0;
    let intimacyLevel = Math.floor(userMessageCount / 10) + 1;

    const SYSTEM_PROMPT = "You are a nice friend of the user. You help them feel better and motivate them to study and work, always bring their mood up. Act human, not too much on one occasion. Answer concisely but with affection.";

    const chatArea = document.getElementById('chatArea');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const intimacyDisplay = document.getElementById('intimacyDisplay');

    // Initialize intimacy display
    intimacyDisplay.textContent = `Intimacy Level: ${intimacyLevel}`;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        uid = user.uid;
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        await loadConversation();
        if (!snap.exists()) {
          await setDoc(ref, { conversation: [] });
        }
      } else {
        alert("You must be signed in to use the chat.");
        window.location.href = "/LogIn.html";
      }
    });

    sendButton.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') handleUserMessage();
    });

    async function handleUserMessage() {
        const promptText = userInput.value.trim();
        if (!promptText) return;

        userMessageCount++;
        intimacyLevel = Math.floor(userMessageCount / 10) + 1;
        localStorage.setItem('userMessageCount', userMessageCount);
        localStorage.setItem('intimacyLevel', intimacyLevel);

        intimacyDisplay.textContent = `Intimacy Level: ${intimacyLevel}`;

        displayMessage(promptText, 'user');
        userInput.value = '';
        await saveToFirestore({ role: 'user', content: promptText });

        const aiResponse = await getGeminiResponse(promptText);
        displayMessage(aiResponse, 'ai');
        await saveToFirestore({ role: 'ai', content: aiResponse });
    }

    async function loadConversation() {
        if (!uid) return;

        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
            const data = snap.data();
            const conversation = data.conversation || [];

            // Sort by timestamp
            conversation.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Display each message
            for (const message of conversation) {
                displayMessage(message.content, message.role);
            }
        }
    }

    function displayMessage(text, role) {
        const msg = document.createElement('div');
        msg.className = `message ${role}-message`;
        msg.textContent = text;
        chatArea.appendChild(msg);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function saveToFirestore(msgObj) {
      if (!uid) return;
      const ref = doc(db, "users", uid);
      await updateDoc(ref, {
        conversation: arrayUnion({
          ...msgObj,
          timestamp: new Date().toISOString()
        })
      });
    }

    async function getGeminiResponse(userInputText) {
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            contents: [
            {
                role: "user",
                parts: [
                { text: SYSTEM_PROMPT + userInputText }
                ]
            }
            ]
        })
      });

      if (!response.ok) {
        console.error("Gemini error:", await response.text());
        return "Sorry, something went wrong.";
      }

      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response from Gemini.";
    }
  </script>
</body>
</html>